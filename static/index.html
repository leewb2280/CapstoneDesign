<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìŠ¤í‚¨ì¼€ì–´ ì„œë²„ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select, button { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; margin-top: 15px; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        pre { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
        .hidden { display: none; }
        .badge { display: inline-block; padding: 5px 10px; background: #e2e6ea; border-radius: 20px; margin-right: 5px; font-size: 0.9em; }
    </style>
</head>
<body>

    <h1>ğŸ§´ AI ìŠ¤í‚¨ì¼€ì–´ ì„œë²„ í…ŒìŠ¤íŠ¸ ì„¼í„°</h1>

    <div class="card">
        <h3>ğŸ› ï¸ ê´€ë¦¬ì ë„êµ¬</h3>
        <button class="secondary" onclick="updateProducts()">ìµœì‹  ì œí’ˆ ë°ì´í„° ì—…ë°ì´íŠ¸ (í¬ë¡¤ë§ ì‹œì‘)</button>
    </div>

    <div class="card">
        <h2>STEP 1. í”¼ë¶€ ë¶„ì„ (ì‚¬ì§„ ì—…ë¡œë“œ)</h2>
        <label>ì‚¬ìš©ì ID</label>
        <input type="text" id="userId" value="test_user" placeholder="ID ì…ë ¥">

        <label>í˜„ì¬ ìˆ˜ë¶„ê° (0~100)</label>
        <input type="number" id="moisture" value="30">

        <label>í˜„ì¬ ìœ ë¶„ê° (0~100)</label>
        <input type="number" id="sebum" value="70">

        <label>ì–¼êµ´ ì‚¬ì§„ ì„ íƒ</label>
        <input type="file" id="imageFile" accept="image/*">

        <button onclick="reqAnalyze()">ğŸ“¸ ë¶„ì„ ì‹œì‘í•˜ê¸°</button>

        <div id="result1Area" class="hidden">
            <h4>ğŸ“Š 1ë‹¨ê³„ ë¶„ì„ ê²°ê³¼</h4>
            <pre id="result1"></pre>
        </div>
    </div>

    <div class="card hidden" id="step2Card">
        <h2>STEP 2. ë§ì¶¤í˜• ì²˜ë°© (ì„¤ë¬¸)</h2>
        <p>âœ… ë¶„ì„ ID: <span id="savedAnalysisId" class="badge">None</span> ê°€ ìë™ ì…ë ¥ë¨</p>

        <label>ìˆ˜ë©´ ì‹œê°„ (ì‹œê°„)</label>
        <input type="number" id="sleep" value="7.0">

        <label>ë¬¼ ì„­ì·¨ëŸ‰ (ml)</label>
        <input type="number" id="water" value="1500">

        <label>ì„¸ì•ˆ íšŸìˆ˜ (í•˜ë£¨)</label>
        <input type="number" id="washFreq" value="2">

        <label>í”¼ë¶€ ë¯¼ê° ì—¬ë¶€</label>
        <select id="sensitivity">
            <option value="no">ì•„ë‹ˆì˜¤ (ê±´ê°•í•¨)</option>
            <option value="yes">ì˜ˆ (ë¯¼ê°í•¨)</option>
        </select>

        <label>ë‚˜ì´</label>
        <input type="number" id="age" value="24">

        <label>ì„ í˜¸ ì œí˜•</label>
        <select id="texture">
            <option value="gel">ì ¤ (ê°€ë²¼ì›€)</option>
            <option value="cream">í¬ë¦¼ (ì´‰ì´‰í•¨)</option>
            <option value="lotion">ë¡œì…˜ (ë¶€ë“œëŸ¬ì›€)</option>
        </select>

        <button onclick="reqRecommend()">ğŸ’Š ìµœì¢… ì²˜ë°© ë°›ê¸°</button>

        <div id="result2Area" class="hidden">
            <h4>ğŸ† ìµœì¢… ì¶”ì²œ ê²°ê³¼</h4>
            <pre id="result2"></pre>
        </div>
    </div>

    <script>
        let currentAnalysisId = null;

        // 1ë‹¨ê³„: ë¶„ì„ ìš”ì²­ í•¨ìˆ˜
        async function reqAnalyze() {
            const userId = document.getElementById('userId').value;
            const fileInput = document.getElementById('imageFile');

            if(fileInput.files.length === 0) { alert("ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }

            const formData = new FormData();
            formData.append("user_id", userId);
            formData.append("moisture", document.getElementById('moisture').value);
            formData.append("sebum", document.getElementById('sebum').value);
            formData.append("file", fileInput.files[0]);

            try {
                const res = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await res.json();

                document.getElementById('result1Area').classList.remove('hidden');
                document.getElementById('result1').innerText = JSON.stringify(data, null, 2);

                if(data.analysis_id) {
                    currentAnalysisId = data.analysis_id;
                    document.getElementById('savedAnalysisId').innerText = currentAnalysisId;
                    document.getElementById('step2Card').classList.remove('hidden'); // 2ë‹¨ê³„ ì—´ê¸°
                    alert("1ë‹¨ê³„ ë¶„ì„ ì™„ë£Œ! ì•„ë˜ ì„¤ë¬¸ì„ ì§„í–‰í•˜ì„¸ìš”.");
                }
            } catch (err) {
                alert("ì—ëŸ¬ ë°œìƒ: " + err);
            }
        }

        // 2ë‹¨ê³„: ì¶”ì²œ ìš”ì²­ í•¨ìˆ˜
        async function reqRecommend() {
            if(!currentAnalysisId) { alert("ë¨¼ì € 1ë‹¨ê³„ ë¶„ì„ì„ ì™„ë£Œí•´ì•¼ í•©ë‹ˆë‹¤."); return; }

            const payload = {
                "user_id": document.getElementById('userId').value,
                "analysis_id": currentAnalysisId,
                "lifestyle": {
                    "sleep_hours_7d": parseFloat(document.getElementById('sleep').value),
                    "water_intake_ml": parseInt(document.getElementById('water').value),
                    "wash_freq_per_day": parseInt(document.getElementById('washFreq').value),
                    "wash_temp": "normal",
                    "sensitivity": document.getElementById('sensitivity').value
                },
                "user_pref": {
                    "age": parseInt(document.getElementById('age').value),
                    "pref_texture": document.getElementById('texture').value
                }
            };

            try {
                const res = await fetch('/recommend', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                document.getElementById('result2Area').classList.remove('hidden');
                document.getElementById('result2').innerText = JSON.stringify(data, null, 2);
            } catch (err) {
                alert("ì—ëŸ¬ ë°œìƒ: " + err);
            }
        }

        // ê´€ë¦¬ì: ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function updateProducts() {
            const formData = new FormData();
            formData.append("secret_key", "admin1234");

            const res = await fetch('/update-products', { method: 'POST', body: formData });
            const data = await res.json();
            alert(data.message);
        }
    </script>
</body>
</html>