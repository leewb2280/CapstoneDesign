<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Skin Advisor Dashboard</title>
    <style>
        body { font-family: 'Pretendard', 'Noto Sans KR', sans-serif; background-color: #f4f6f8; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        /* ê³µí†µ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 800px; margin-bottom: 20px; box-sizing: border-box; }

        /* ë¡œê·¸ì¸/ê°€ì… ì „ìš© ìŠ¤íƒ€ì¼ (ì‘ê³  ì¤‘ì•™ ì •ë ¬) */
        .auth-container { max-width: 400px; margin-top: 50px; text-align: center; }
        .auth-container h2 { margin-top: 0; color: #333; font-size: 1.8em; }
        .auth-link { margin-top: 20px; font-size: 0.9em; color: #666; }
        .auth-link span { color: #007bff; cursor: pointer; font-weight: bold; text-decoration: underline; }
        .auth-link span:hover { color: #0056b3; }

        /* í¼ ìš”ì†Œ */
        label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.9em; color: #555; text-align: left; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; transition: border 0.2s; }
        input:focus, select:focus { border-color: #007bff; outline: none; }
        input[readonly] { background-color: #f1f3f5; color: #495057; cursor: default; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { width: 100%; padding: 14px; margin-top: 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.05em; transition: all 0.2s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; transform: translateY(-1px); }
        .btn-success { background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }

        /* ìƒë‹¨ ìƒíƒœë°” */
        .status-bar { width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px; box-sizing: border-box; }
        .user-info { font-weight: bold; color: #444; }
        .btn-logout { background: #ff6b6b; color: white; padding: 8px 15px; font-size: 0.9em; border-radius: 6px; width: auto; margin: 0; }

        /* ìœ í‹¸ë¦¬í‹° */
        .hidden { display: none !important; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; text-align: left; }
        .badge { background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; color: #495057; }

        /* ê¸°ë¡ í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.95em; }
        th { background: #f8f9fa; color: #555; }
    </style>
</head>
<body>

    <div id="topBar" class="status-bar hidden">
        <div class="user-info" id="statusText"></div>
        <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="authContainer" class="card auth-container">

        <div id="loginForm">
            <h2>ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤</h2>
            <p style="color:#666; margin-bottom:30px;">AI ìŠ¤í‚¨ ì–´ë“œë°”ì´ì € ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>

            <input type="text" id="loginId" placeholder="ì•„ì´ë”” ì…ë ¥">
            <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.keyCode==13) reqLogin()">

            <button class="btn-primary" onclick="reqLogin()">ë¡œê·¸ì¸</button>

            <div class="auth-link">
                ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <span onclick="toggleAuth('signup')">íšŒì›ê°€ì…</span>
            </div>
        </div>

        <div id="signupForm" class="hidden">
            <h2>ğŸ“ íšŒì›ê°€ì…</h2>
            <p style="color:#666; margin-bottom:20px;">ìƒˆë¡œìš´ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>

            <input type="text" id="signId" placeholder="ì‚¬ìš©í•  ì•„ì´ë””">
            <input type="password" id="signPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <input type="text" id="signName" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">

            <button class="btn-success" onclick="reqSignup()">ê°€ì…í•˜ê¸°</button>

            <div class="auth-link">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <span onclick="toggleAuth('login')">ë¡œê·¸ì¸</span>
            </div>
        </div>
    </div>


    <div id="mainApp" class="hidden" style="width: 100%; max-width: 800px;">

        <div class="card">
            <h3 style="margin-top:0;">ğŸ› ï¸ ë§ˆì´í˜ì´ì§€</h3>
            <div class="grid-2">
                <button class="btn-secondary" style="margin-top:0;" onclick="reqHistory()">ğŸ“œ ì§€ë‚œ ì§„ë‹¨ ê¸°ë¡ ë³´ê¸°</button>
                <button class="btn-secondary" style="margin-top:0;" onclick="updateProducts()">ğŸ“¦ [ê´€ë¦¬ì] ë°ì´í„° ì—…ë°ì´íŠ¸</button>
            </div>

            <div id="historyArea" class="hidden">
                <table id="historyTable">
                    <thead><tr><th>ë‚ ì§œ</th><th>í”¼ë¶€ë‚˜ì´</th><th>ì¶”ì²œì œí’ˆ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h2 style="margin-top:0;">STEP 1. í”¼ë¶€ ì´¬ì˜</h2>

            <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; gap:20px; align-items:center;">
                <span style="font-weight:bold; color:#555;">ğŸ“¸ ëª¨ë“œ ì„ íƒ:</span>
                <label style="margin:0; font-weight:normal; cursor:pointer;">
                    <input type="radio" name="scanMode" value="upload" checked onclick="toggleMode()">
                    íŒŒì¼ ì—…ë¡œë“œ (PC/í°)
                </label>
                <label style="margin:0; font-weight:normal; cursor:pointer;">
                    <input type="radio" name="scanMode" value="camera" onclick="toggleMode()">
                    ë¼ì¦ˆë² ë¦¬íŒŒì´ ì´¬ì˜ (í‚¤ì˜¤ìŠ¤í¬)
                </label>
            </div>

            <div class="grid-2">
                <div>
                    <label>í˜„ì¬ ì‚¬ìš©ì</label>
                    <input type="text" id="currentUserId" readonly>
                </div>

                <div id="uploadGroup">
                    <label>ì–¼êµ´ ì‚¬ì§„ ì—…ë¡œë“œ</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>

                <div id="cameraGroup" class="hidden" style="display: flex; align-items: flex-end;">
                    <div style="padding: 10px; background: #e3f2fd; color: #0d47a1; border-radius: 6px; width: 100%; text-align: center;">
                        ğŸ¤– <b>ë¼ì¦ˆë² ë¦¬íŒŒì´ ì¹´ë©”ë¼</b>ê°€ ì‘ë™í•©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div><label>ìˆ˜ë¶„ (0~100)</label><input type="number" id="moisture" value="30"></div>
                <div><label>ìœ ë¶„ (0~100)</label><input type="number" id="sebum" value="70"></div>
            </div>

            <button class="btn-primary" onclick="reqAnalyze()">ğŸ“¸ ë¶„ì„ ì‹œì‘í•˜ê¸°</button>

            <div id="result1Area" class="hidden" style="margin-top:20px;">
                <h4>ğŸ“Š 1ë‹¨ê³„ ë¶„ì„ ê²°ê³¼</h4>
                <pre id="result1"></pre>
            </div>
        </div>

        <div class="card hidden" id="step2Card">
            <h2 style="margin-top:0;">STEP 2. ë§ì¶¤ ì²˜ë°©</h2>
            <p>âœ… ë¶„ì„ ID: <span id="savedAnalysisId" class="badge">None</span></p>

            <div class="grid-2">
                <div><label>ìˆ˜ë©´ ì‹œê°„</label><input type="number" id="sleep" value="7.0"></div>
                <div><label>ë¬¼ ì„­ì·¨ëŸ‰(ml)</label><input type="number" id="water" value="1500"></div>
                <div><label>ì„¸ì•ˆ íšŸìˆ˜</label><input type="number" id="washFreq" value="2"></div>
                <div><label>ë‚˜ì´</label><input type="number" id="age" value="24"></div>
            </div>
            <label>ë¯¼ê°ì„± ì—¬ë¶€</label>
            <select id="sensitivity"><option value="no">ì•„ë‹ˆì˜¤</option><option value="yes">ì˜ˆ</option></select>
            <label>ì„ í˜¸ ì œí˜•</label>
            <select id="texture"><option value="gel">ì ¤</option><option value="cream">í¬ë¦¼</option><option value="lotion">ë¡œì…˜</option></select>

            <button class="btn-success" onclick="reqRecommend()">ğŸ’Š ìµœì¢… ì²˜ë°© ë°›ê¸°</button>

            <div id="result2Area" class="hidden" style="margin-top:20px;">
                <h4>ğŸ† ìµœì¢… ì¶”ì²œ ê²°ê³¼</h4>
                <pre id="result2"></pre>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentAnalysisId = null;

        // í™”ë©´ ì „í™˜ í•¨ìˆ˜ (ë¡œê·¸ì¸ <-> íšŒì›ê°€ì…)
        function toggleAuth(target) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');

            // ì…ë ¥ê°’ ì´ˆê¸°í™”
            document.querySelectorAll('#authContainer input').forEach(input => input.value = '');

            if(target === 'signup') {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            } else {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        }

        // ë¡œê·¸ì¸ ìš”ì²­
        async function reqLogin() {
            const id = document.getElementById('loginId').value;
            const pw = document.getElementById('loginPw').value;
            if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                const res = await fetch('/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: id, password: pw, name: "user" })
                });
                const data = await res.json();

                if (res.ok) {
                    currentUser = data.user_info;
                    // í™”ë©´ ì „í™˜ (ì¸ì¦ì°½ ìˆ¨ê¹€ -> ë©”ì¸ ë³´ì„)
                    document.getElementById('authContainer').classList.add('hidden');
                    document.getElementById('topBar').classList.remove('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');

                    document.getElementById('statusText').innerHTML = `ğŸ‘¤ <b>${currentUser.name}</b>ë‹˜`;
                    document.getElementById('currentUserId').value = currentUser.user_id;
                } else {
                    alert(data.detail);
                }
            } catch (e) { alert("ì„œë²„ ì˜¤ë¥˜: " + e); }
        }

        // íšŒì›ê°€ì… ìš”ì²­
        async function reqSignup() {
            const id = document.getElementById('signId').value;
            const pw = document.getElementById('signPw').value;
            const name = document.getElementById('signName').value;
            if(!id || !pw) return alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");

            try {
                const res = await fetch('/signup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: id, password: pw, name: name })
                });
                if (res.ok) {
                    alert("ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    toggleAuth('login'); // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                } else {
                    const err = await res.json();
                    alert(err.detail);
                }
            } catch (e) { alert("ì„œë²„ ì˜¤ë¥˜: " + e); }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            location.reload();
        }

        // ë¶„ì„ ìš”ì²­
        // ëª¨ë“œ ì „í™˜ í•¨ìˆ˜
        function toggleMode() {
            const mode = document.querySelector('input[name="scanMode"]:checked').value;
            const uploadGroup = document.getElementById('uploadGroup');
            const cameraGroup = document.getElementById('cameraGroup');
            const moistInput = document.getElementById('moisture');
            const sebumInput = document.getElementById('sebum');

            if (mode === 'upload') {
                uploadGroup.classList.remove('hidden');
                cameraGroup.classList.add('hidden');
                // ìˆ˜ë™ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ
                moistInput.readOnly = false;
                sebumInput.readOnly = false;
                moistInput.style.backgroundColor = "white";
                sebumInput.style.backgroundColor = "white";
            } else {
                uploadGroup.classList.add('hidden');
                cameraGroup.classList.remove('hidden');
                // ì„¼ì„œê°’ì€ ìë™ìœ¼ë¡œ ë“¤ì–´ì˜¤ë¯€ë¡œ ì…ë ¥ ë§‰ê¸°
                moistInput.readOnly = true;
                sebumInput.readOnly = true;
                moistInput.value = "0"; // ì¸¡ì • ëŒ€ê¸° ìƒíƒœ
                sebumInput.value = "0";
                moistInput.style.backgroundColor = "#e9ecef";
                sebumInput.style.backgroundColor = "#e9ecef";
            }
        }

        // ë¶„ì„ ìš”ì²­ í•¨ìˆ˜ (í†µí•©)
        async function reqAnalyze() {
            if(!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

            const mode = document.querySelector('input[name="scanMode"]:checked').value;

            // [A] íŒŒì¼ ì—…ë¡œë“œ ëª¨ë“œ (ê¸°ì¡´ ë°©ì‹)
            if (mode === 'upload') {
                const fileInput = document.getElementById('imageFile');
                if(fileInput.files.length === 0) return alert("ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

                const formData = new FormData();
                formData.append("user_id", currentUser.user_id);
                formData.append("moisture", document.getElementById('moisture').value);
                formData.append("sebum", document.getElementById('sebum').value);
                formData.append("file", fileInput.files[0]);

                try {
                    const res = await fetch('/analyze', { method: 'POST', body: formData });
                    const data = await res.json();
                    if(!res.ok) throw new Error(data.detail);
                    handleAnalyzeSuccess(data);
                } catch (err) { alert(err); }
            }

            // [B] ë¼ì¦ˆë² ë¦¬íŒŒì´ ì´¬ì˜ ëª¨ë“œ (ìƒˆë¡œìš´ ë°©ì‹)
            else {
                const formData = new FormData();
                formData.append("user_id", currentUser.user_id);

                try {
                    alert("ğŸ“¸ ì´¬ì˜ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...");
                    // ì„¼ì„œì™€ ì¹´ë©”ë¼ë¥¼ ì‘ë™ì‹œí‚¤ëŠ” API í˜¸ì¶œ
                    const res = await fetch('/analyze-hardware', { method: 'POST', body: formData });
                    const data = await res.json();

                    if(!res.ok) throw new Error(data.detail);

                    // ì¸¡ì •ëœ ì„¼ì„œê°’ í™”ë©´ì— í‘œì‹œ
                    document.getElementById('moisture').value = data.sensor_data.moisture;
                    document.getElementById('sebum').value = data.sensor_data.sebum;

                    handleAnalyzeSuccess(data);
                    alert("âœ… ì´¬ì˜ ë° ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                } catch (err) { alert("í•˜ë“œì›¨ì–´ ì˜¤ë¥˜: " + err); }
            }
        }

        // ì„±ê³µ ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜
        function handleAnalyzeSuccess(data) {
            document.getElementById('result1Area').classList.remove('hidden');
            document.getElementById('result1').innerText = JSON.stringify(data.gpt_result, null, 2);

            if(data.analysis_id) {
                currentAnalysisId = data.analysis_id;
                document.getElementById('savedAnalysisId').innerText = currentAnalysisId;
                document.getElementById('step2Card').classList.remove('hidden');
                document.getElementById('step2Card').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // ì¶”ì²œ ìš”ì²­
        async function reqRecommend() {
            if(!currentAnalysisId) return alert("ë¶„ì„ë¶€í„° ì§„í–‰í•˜ì„¸ìš”.");

            const payload = {
                "user_id": currentUser.user_id,
                "analysis_id": currentAnalysisId,
                "lifestyle": {
                    "sleep_hours_7d": parseFloat(document.getElementById('sleep').value),
                    "water_intake_ml": parseInt(document.getElementById('water').value),
                    "wash_freq_per_day": parseInt(document.getElementById('washFreq').value),
                    "wash_temp": "normal",
                    "sensitivity": document.getElementById('sensitivity').value
                },
                "user_pref": {
                    "age": parseInt(document.getElementById('age').value),
                    "pref_texture": document.getElementById('texture').value
                }
            };

            try {
                const res = await fetch('/recommend', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                document.getElementById('result2Area').classList.remove('hidden');
                document.getElementById('result2').innerText = JSON.stringify(data, null, 2);
            } catch (err) { alert(err); }
        }

        // ê¸°ë¡ ì¡°íšŒ
        async function reqHistory() {
            try {
                const res = await fetch(`/history/${currentUser.user_id}`);
                const data = await res.json();
                const tbody = document.querySelector('#historyTable tbody');
                tbody.innerHTML = "";

                if(data.history.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='3'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                } else {
                    data.history.forEach(item => {
                        tbody.innerHTML += `<tr>
                            <td>${item.date.split(' ')[0]}</td>
                            <td>${item.skin_age}ì„¸</td>
                            <td>${item.top3_names.join(', ')}</td>
                        </tr>`;
                    });
                }
                document.getElementById('historyArea').classList.remove('hidden');
            } catch (e) { alert(e); }
        }

        // ê´€ë¦¬ì
        async function updateProducts() {
            const formData = new FormData();
            formData.append("secret_key", "admin1234");
            const res = await fetch('/update-products', { method: 'POST', body: formData });
            const data = await res.json();
            alert(data.message);
        }
    </script>
</body>
</html>